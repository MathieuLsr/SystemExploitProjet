#include "acquisition.h"
#include "../Utils/utils.h"
#include "../Utils/MPacket.h"

// Pour printf
#include <stdio.h>

// Exit
#include <stdlib.h>

// Open/Close/FD
#include <sys/uio.h>
#include <unistd.h>

// O_RD O_WR
#include <fcntl.h>

// contient la déclaration de mode_t 
#include <sys/types.h>    
// contient le prototype de mkfifo()
#include <sys/stat.h>     

// Pour kill
#include <signal.h>

// Pour les sockets
#include <sys/socket.h>
#include <sys/types.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <netinet/tcp.h>

//#define SERVER "127.0.0.1"
//#define PORT 8081

#define PREFIX "[Server Acquisition]"

int socket_server_terminal = -1 ;
int socket_client_terminal = -1 ;


int main(int argc, char const *argv[])
{
    printf("%s Démarrage du serveur Acquisition\n", PREFIX) ;
    

    if(fork() == 0){
        char str[4] ;
        while(strcmp(str, "exit")) fgets(str, 5, stdin) ;

        int true = 1 ;
        setsockopt(socket_client_terminal,SOL_SOCKET,SO_REUSEADDR, &true,sizeof(int)) ;
        setsockopt(socket_server_terminal,SOL_SOCKET,SO_REUSEADDR, &true,sizeof(int)) ;

        kill(getppid(), SIGINT) ;
        
        printf("%s Fin du programme.\n", PREFIX) ;
        return 0 ;
    }

    int sd ;
    unsigned char byte;

    int ports[2] = {PORT_VALIDATION_1, PORT_VALIDATION_2} ;
    int sizePorts = sizeof(ports)/sizeof(int) ;
    
    char* buffer ;
    
    int portSecurity = -1 ; 
    while(socket_server_terminal == -1){
        portSecurity++ ;
        socket_server_terminal = InitPacketReceive(PORT_ACQUISITION+portSecurity) ;
    }

    //printf("%s Debug 3\n", PREFIX) ;
    //printf("%s sd = %d, PORT : %d\n", PREFIX, socket_server_terminal, PORT_ACQUISITION) ;
    printf("%s Server acquisition lié au port %d\n", PREFIX, PORT_ACQUISITION+portSecurity) ;

    while(1) {
        
        //printf("%s Debug 4\n", PREFIX) ;
        char* msg = readSocket(socket_server_terminal) ;
        printf("Receive : %s\n", msg);
        //free(msg);

        struct MPacket* p = MPacket_Create(msg) ;

        //int id_pass = atoi(msg) ;
        //long long id_pass = strtoll(msg, NULL, 0) ;

        int id_server =  MPacket_GetServer(p) ;
        int i, find = FALSE_VALUE;

        

        for(i=0 ; i<sizePorts ; i++){
            if(ports[i] == id_server) {
                find = TRUE_VALUE ;
                break ;
            }
        }

        printf("%s Id_Server : %d, value : %d\n", PREFIX, id_server, find) ;

        char* str_debug = "Validation" ;

        if(find == FALSE_VALUE){
            // Send to Server Inter-Archive
            // Si introuvable, on renvoie false à Terminal
            if(SendNewPacket(SERVER_INTERARCHIVES, PORT_INTERARCHIVES, msg, strlen(msg)) == -1){
                SendNewPacket(SERVER_TERMINAL, PORT_TERMINAL, "false", strlen("false")) ;
                printf("%s Echec de l'envoie du packet au server %s sur le port %d\n", PREFIX, SERVER_VALIDATION, PORT_INTERARCHIVES) ;
                continue ;
            }

            str_debug = "InterArchives" ;
        }

        else {
            if(SendNewPacket(SERVER_VALIDATION, id_server, msg, strlen(msg)) == -1){
                SendNewPacket(SERVER_TERMINAL, PORT_TERMINAL, "false", strlen("false")) ;
                printf("%s Echec de l'envoie du packet au server %s sur le port %d\n", PREFIX, SERVER_VALIDATION, id_server) ;
                continue ;
            }
        }
        

        // Send to serveur Validation

        //printf("%s Id_Pass : %lld, Id_Server = %d\n", PREFIX, id_pass, id_server) ;
        printf("%s MPacket reçu : %s\n", PREFIX, msg) ;

        msg = readSocket(socket_server_terminal) ;
        printf("Receive %s : %s\n", str_debug, msg);
        

        //send(socket_server_terminal, reponse, strlen(reponse), 0) ;
        SendNewPacket(SERVER_TERMINAL, PORT_TERMINAL, msg, strlen(msg)) ;
        //printf("%s Message envoyé : %s\n", PREFIX, reponse) ;

        //printf("%s Fonctionnel ! cd : %d, buffer = %s\n", PREFIX, cd, buff);
        //printf("%s %s", PREFIX, c_ain) ;
    }

    /*
    int sd ;
    struct sockaddr sock ;

    sd = socket(PF_INET, SOCK_STREAM, SOCK_STREAM);

    printf("%s Socket %d\n", PREFIX, sd) ;
    */
    //sock.sin_family = AF_INET;
    //sock.sin_addr.s_addr = INADDR_ANY;
    //sock.sin_port = htons(1025);




    /*
    int t ;
    for(t = 0 ; t<argc ; t++) 
        printf("%s %s\n", PREFIX, argv[t]) ;

    

    //      Partie avec les pipes        //

    if(argc != 4){
        printf("%s Usage : ./acquisition [pathFifo_Terminal_Acquisition] [pathFifo_Acquisition_Terminal] [pathFifo_Acquisition_Validation] [pathFifo_Validation_Acquisition]\n", PREFIX) ;
        exit(1) ;
    }
    
    
    char* pipe_acquisition_validation = (char*) argv[2] ;
    char* pipe_validation_acquisition = (char*) argv[3] ;

    int fd_input_validation = open(pipe_validation_acquisition, O_RDONLY | O_NONBLOCK) ;
    int fd_output_validation = open(pipe_acquisition_validation, O_WRONLY | O_NONBLOCK) ;

    printf("%s fd_input_terminal = %d\n", PREFIX, fd_input_validation) ;
    printf("%s fd_output_terminal = %d\n", PREFIX, fd_output_validation) ;

    char* pipe_terminal_acquisition = (char*) argv[0] ;
    char* pipe_acquisition_terminal = (char*) argv[1] ;
    
    int fd_input_terminal = open(pipe_terminal_acquisition, O_RDONLY) ;
    int fd_output_terminal = open(pipe_acquisition_terminal, O_WRONLY) ;

    printf("%s fd_input_terminal = %d\n", PREFIX, fd_input_terminal) ;
    printf("%s fd_output_terminal = %d\n", PREFIX, fd_output_terminal) ;
    */


    //printf("%s %s (%d), %s (%d)", PREFIX, pipe_terminal_acquisition, fd_terminal_acquisition, pipe_acquisition_validation, fd_acquisition_validation) ;

    printf("%s Fin du serveur Acquisition\n", PREFIX) ;
    return 0 ;
}


