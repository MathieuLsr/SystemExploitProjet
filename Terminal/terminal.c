#include "terminal.h" 
#include "../Utils/utils.h"
#include "../Utils/MPacket.h"

// Lib stdio
#include <stdio.h>

// Include pour strcat
#include <string.h>

// Pour les fork & execl
#include <unistd.h>

// Pour wait les process
#include <sys/wait.h>

// Pour Exit
#include <stdlib.h>

// Open/Close/FD
// O_RD O_WR
#include <fcntl.h>

// Pour kill
#include <signal.h>

// contient la déclaration de mode_t 
#include <sys/types.h>    
// contient le prototype de mkfifo()
#include <sys/stat.h>     

// Pour les sockets
#include <sys/socket.h>
#include <sys/types.h>

#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
#include <stdio.h>
#include <errno.h>

//#define SERVER "127.0.0.1"
//#define PORT 8080

#define PREFIX "[Server Terminal]"

int socket_server = -1 ;



int Send_New_Request(char* str){
    
        if(SendNewPacket(SERVER_ACQUISITION, PORT_ACQUISITION, str, strlen(str)) == -1){
            printf("%s Echec de l'envoie du packet au server %s sur le port %d\n", PREFIX, SERVER_ACQUISITION, PORT_ACQUISITION) ;
            return 1 ; 
            //continue ;
        }
        printf("%s Packet envoyé... En attente d'une réponse.\n", PREFIX) ;

        char* msg = readSocket(socket_server) ;
        printf("%s Réponse du serveur : %s\n", PREFIX, msg);
        free(msg);
        return 0 ; 
}


int QuitPrograms(){
    int true = 1 ;
    setsockopt(socket_server,SOL_SOCKET,SO_REUSEADDR, &true,sizeof(int)) ;
    printf("%s Fin du programme.\n", PREFIX) ;
    exit(0) ; 
}


int main(int argc, char const *argv[]) 
{
    
    printf("%s Démarrage du serveur Terminal\n", PREFIX) ;


    /*
    if(fork() == 0){
        char str[4] ;
        while(strcmp(str, "exit")) fgets(str, 5, stdin) ;

        int true = 1 ;
        setsockopt(socket_server,SOL_SOCKET,SO_REUSEADDR, &true,sizeof(int)) ;

        kill(getppid(), SIGINT) ;
        
        printf("%s Fin du programme.\n", PREFIX) ;
        return 0 ;
    }
    */


    socket_server = InitPacketReceive(PORT_TERMINAL) ;
    printf("%s Socket_server : %d\n", PREFIX, socket_server) ;


    FILE *fp;
    char buff[1000];
    fp = fopen("./Terminal/datas.txt", "r");
    fgets(buff, 1000, (FILE*)fp);
    fclose(fp);

    
    int i ;
    

    char *sep = ";";
    char *line, *brkt;

    for (i=0, line = strtok_r(buff, sep, &brkt); line; i++, line = strtok_r(NULL, sep, &brkt)){
        printf("---\n") ;
        struct MPacket* packet = MPacket_Create(line) ;
        if(Send_New_Request(packet->str_defaut) == 1) continue ;
        //MPacket_println(packet) ;
        //MPacket_GetServer(packet) ;
    }

    /*
    struct MPacket* p ; 
    i=0 ; 
    while((p = Packets[i]) != NULL){
        printf("---\n") ;
        MPacket_println(p) ;
        i++ ; 
    }
    */

    while(1){

        char IdPass[31] ;
        //char* IdPass = malloc(16*sizeof(char)+1);

        printf("%s\n", PREFIX) ;
        printf("%s Entrez votre IdPass : \n", PREFIX) ;
        printf("%s\n%s ", PREFIX, PREFIX) ;
        

        char* c = fgets(IdPass, 100, stdin) ;

        if(!strcmp(c, "exit\n")) QuitPrograms() ; 

        printf("%s Id entré : %s", PREFIX, c) ; 
        printf("Debug 1 : %lu, %lu\n", strlen(c), strlen(IdPass)) ; 
        if(strlen(c) != 30) {
            printf("%s Saisie incorrecte. Utilisation : [IdPass:16],D,[Data:10:dd/mm/yyyy]\n", PREFIX) ; 
            continue ; 
        }

        struct MPacket* packet = MPacket_Create(c) ;
        if(Send_New_Request(IdPass) == 1) continue ;
        
    }   

    printf("%s Fin du Terminal.\n", PREFIX) ;

    return 0 ;
}
