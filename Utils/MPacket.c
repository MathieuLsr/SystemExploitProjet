#include "MPacket.h"

#include <stdlib.h>
#include <string.h>

// Pour les sockets
#include <sys/socket.h>
#include <sys/types.h>

#include <unistd.h>
#include <netinet/in.h>
#include <netdb.h>
#include <stdio.h>
#include <errno.h>


struct MPacket* MPacket_Create(char* str){
    struct MPacket* p = malloc(sizeof p) ;

    char * copy = malloc(strlen(str) + 1); 
    strcpy(copy, str);

    p->str_defaut = malloc(strlen(str) + 1); 
    
    char *sep = ",";
    char *word, *brkt;
    char *args[NombreElements] ; 
    int i ;
    for (i = 0, word = strtok_r(copy, sep, &brkt); word; i++, word = strtok_r(NULL, sep, &brkt)){
        args[i] = word ;
    }

    p->id_pass = strtoll(args[ID_PASS_PLACE], NULL, 0) ;
    p->date = args[DATE_PLACE] ;
    p->type = args[TYPE_PLACE] ;
    p->str_defaut = str ; 
    
    return p ; 
} 

char* strfromlong(long value){
  char buf[32], *p;
  unsigned long long v;

  v = (value < 0) ? -value: value;
  p = buf + 31;
  do{
    *p -- = '0' + (v%10);
    v /= 10;
  } while(v);
  if(value < 0) *p -- = '-';
  p ++;

  int len = 32 - (p - buf);
  char *s = (char*)malloc(sizeof(char) * (len + 1));
  memcpy(s, p, len);
  s[len] = '\0';
  return s;
}

struct MPacket* MPacket_Build(long id, char* type, char* value){

    printf("Start build\n") ;
    struct MPacket* p = malloc(sizeof(p)) ;

    p->id_pass = id ; 
    p->type = type ;
    p->date = value ;
    printf("Start long to string\n") ;

    char* str = strfromlong(id) ;
    printf("str : %s\n", str) ;


    //p->str_defaut = malloc(strlen(str) + 1) ;
    //strcpy(p->str_defaut, str) ;
    return p ;
}

int MPacket_IsValidTime(struct MPacket* p) {

    int today = 8200 ;

    int lastInjection = today - MPacket_GetTimeDays(p) ;
    printf("Last injection : %d\n", lastInjection) ;
    if(lastInjection > 0) return TRUE_VALUE ;
    return FALSE_VALUE ;

}

int MPacket_println(struct MPacket* packet){
    printf("IdPass : %llu ||| Date : %s ||| Type : %s ||| TimeDays : %lldd\n", packet->id_pass, packet->date, packet->type, MPacket_GetTimeDays(packet)) ;
    return 0 ;
}

char* MPacket_formatted(struct MPacket* p) {
    return p->str_defaut ;
}

int MPacket_GetServer(struct MPacket* p) {
    long i = p->id_pass ;
    int srv = i/1000000000000 ;
    return srv ; 
}

long MPacket_GetPass(struct MPacket* p) {
    int srv = MPacket_GetServer(p) ;
    long i = p->id_pass - (srv*1000000000000) ;
    return i ; 
}

long long MPacket_GetTimeDays(struct MPacket* p){

    char *sep = "/";
    char *word, *brkt ;

    char * copy = malloc(strlen(p->date) + 1); 
    strcpy(copy, p->date);

    int d[3] ; 
    int i ;
    for (i = 0, word = strtok_r(copy, sep, &brkt); word; i++, word = strtok_r(NULL, sep, &brkt)){
        d[i] = atoi(word) ;
    }
 
    long long time = 0 ; 

    int day = d[0] ;
    int month = d[1] * 30 ;
    int year = (d[2]-2000) * 365;

    time += day + month + year ;

    return time ;
}




int MPacket_Set_Element(struct MPacket* packet, int key, char* value){
    
    printf("Set value : %s\n", value) ;
    return 0 ; 
    /*
    size_t sizeFullParse = strlen(packet->elements) + 1 +  strlen(value) + 1;
    char* fullParse = malloc(sizeFullParse) ;

    strcpy(fullParse, packet->elements);
    strcat(fullParse, ",");
    strcat(fullParse, value);

    printf("Full name = %s\n", fullParse) ;
    */
    /*
    if(packet->nbElements != 0) concatStrings(concatStrings(buffer, ",", '\0', MAX) - 1, value, '\0', MAX);
    concatStrings(concatStrings(buffer, str, '\0', MAX) - 1, value, '\0', MAX);
    packet->nbElements = packet->nbElements+1 ;
    packet->elements = buffer ;
    */

    return 0 ; 
}

//char* MPacket_Build(struct MPacket* packet){
    /*
    int i;
    char* final ;

    
    for(i=0;i<NombreElements ; i++){
        if(packet->elements[i] == NULL) continue ; 
        
        
        
    }
    printf("Size : %d\n", size) ;
    final = malloc(sizeof(char) * size); 

    char* chaine1="Bonjour ";
    char chaine2[20]="Edouard";
    strncat(chaine1,chaine2,2); 
    printf("%s\n",chaine1);

    for(i=0;i<NombreElements ; i++){
        */
        /*
        char* v = "," ;

        
        if(i != 0) strncat(final, v, 1);
        char* item = packet->elements[i] ;
        if(item == NULL) continue ;

        printf("- Item : %s\n", item) ;
        strncat(final, v, 1) ;

        //char* s ; 
        //strcpy(s, final) ;
        
        //size_t fullSize = strlen(final) + 1 +  strlen( s ) + 1;
        
        //final = (char *) malloc( fullSize );
        printf("test 1 : %s\n", final) ;
        strncat( final, item, strlen(item));
        printf("test 2 : %s\n", final) ;
        
        //printf("Str : %s\n", str) ;
        //if(s != NULL) printf("- %s\n", s) ;
        */
    //}
    //return "final" ; 
//}

/*******************************************/

int InitPacketReceive(int PORT) {


    struct sockaddr_in s_ain;
    int s = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);

    bzero((char *)&s_ain, sizeof(s_ain));
    s_ain.sin_family = AF_INET;s_ain.sin_family = AF_INET;
    s_ain.sin_addr.s_addr = INADDR_ANY ;
    s_ain.sin_port = htons(PORT);

    //printf("%s Debug 1\n", "[PREFIX]") ;

    if(bind(s, (struct sockaddr *)&s_ain, sizeof(s_ain)) == -1) {
        fprintf(stderr, "%s\n", "err bind");
        return -1;
    }

    //printf("%s Debug 2\n", "[PREFIX]") ;

    if(listen(s, 5) == -1) {
        fprintf(stderr, "%s\n", "err listen");
        return -1;
    }


    return s ;

}


char* readMsg(int sockfd, size_t *msgSize)
{
    *msgSize = 0;

    unsigned int length = 0;
    int bytes_read = read(sockfd, &length, sizeof(length)); //Receive number of bytes
    if (bytes_read <= 0) {
        perror("Error in receiving message from server\n");
        return NULL;
    }
    length = ntohl(length);

    char *buffer = malloc(length+1);
    if (!buffer) {
        perror("Error in allocating memory to receive message from server\n");
        return NULL;
    }

    char *pbuf = buffer;
    unsigned int buflen = length;
    while (buflen > 0) {
        bytes_read = read(sockfd, pbuf, buflen); // Receive bytes
        if (bytes_read <= 0) {
            perror("Error in receiving message from server\n");
            free(buffer);
            return NULL;
        }
        pbuf += bytes_read;
        buflen -= bytes_read;
    }

    *msgSize = length;
    return buffer;
}


char* readSocket(int socket_server){
        
        struct sockaddr_in c_ain;   
        socklen_t size = sizeof(c_ain);  

        int cd = accept(socket_server, (struct sockaddr *)&c_ain, (socklen_t*)&size);
        //printf("%s Debug 5 : %d\n", "[PREFIX]", cd) ;
        size_t msgSize;
        char *msg = readMsg(cd, &msgSize); 
        if (!msg) {
            close(cd);
            return "NULL";
        }

        return msg;
}



/***********************************************/


int sendMsg(int sockfd, char *msg, size_t msgSize)
{
    unsigned int convertedNum = htonl(msgSize);
    if (write(sockfd, &convertedNum, sizeof(convertedNum)) < 0) { //Send number of bytes
        perror("error writing to socket");
        return -1;
    }

    if (write(sockfd, msg, msgSize) < 0) { //Send bytes
        perror("error writing to socket");
        return -1;
    }

    return 0;
}

int SendNewPacket(char* SERVER, int PORT, char* str, int size){

    struct hostent *hp;
    struct sockaddr_in s_ain;
    unsigned char byte;
    int socket_client; 

    hp = gethostbyname(SERVER) ;
    bzero((char *)&s_ain, sizeof(s_ain));
    s_ain.sin_family = AF_INET;
    memcpy(&(s_ain.sin_addr),  hp->h_addr, hp->h_length);
    s_ain.sin_port = htons(PORT);

    socket_client = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);

    if(connect(socket_client, (struct sockaddr*) &s_ain, sizeof(s_ain)) == -1 ) {
        fprintf(stderr, "%s\n", "err connect");
        return -1;
    }


    if (sendMsg(socket_client, str, size) != 0) {
        close(socket_client);
        return 1;
    }
    //printf("%s Send is done \n", "[PREFIX]");
    return 0 ; 
}