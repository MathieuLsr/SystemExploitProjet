#include "validation.h"
#include "../Utils/utils.h"
#include "../Utils/MPacket.h"

// Pour printf
#include <stdio.h>

// Exit
#include <stdlib.h>

// Open/Close/FD
#include <sys/uio.h>
#include <unistd.h>

#include <string.h>

// O_RD O_WR
#include <fcntl.h>

// contient la déclaration de mode_t 
#include <sys/types.h>    
// contient le prototype de mkfifo()
#include <sys/stat.h>     
#include <sys/socket.h>

// Pour kill
#include <signal.h>


#define READ 0 
#define WRITE 1 

#define TRUE 0
#define FALSE 1

#define PREFIX "[Server Validation]"

int ID = 0 ; 

int IsValid(char* msg){
    if(strcmp(msg, "test\n")) return TRUE ;
    return FALSE ;
}

int main(int argc, char const *argv[])
{
    printf("%s Démarrage du serveur Validation\n", PREFIX) ;

    int socket_server = -1 ;

    if(fork() == 0){
        char str[4] ;
        while(strcmp(str, "exit")) fgets(str, 5, stdin) ;

        int true = 1 ;
        setsockopt(socket_server,SOL_SOCKET,SO_REUSEADDR, &true,sizeof(int)) ;

        kill(getppid(), SIGINT) ;
        
        printf("%s Fin du programme.\n", PREFIX) ;
        return 0 ;
    }

    if(argc != 2){
        printf("%s Utilisation : ./validation [id_server]\n", PREFIX) ;
        return -1 ;
    }

    // LoadDatasIdPass() ; // Load en cache les données d'un file
    // Tous les pass validés
    long tab[3] = {123456783232, 123456783237, 123456783239} ; 
    int sizeTab = sizeof(tab)/sizeof(long) ;

    printf("Sizetab : %d\n", sizeTab) ;

    int id = atoi(argv[1]) ;
    int port = id == 1 ? PORT_VALIDATION_1 : PORT_VALIDATION_2 ;

    socket_server = InitPacketReceive(port) ;
    printf("%s Socket_server : %d, Id_Server : %d, Port : %d\n", PREFIX, socket_server, id, port) ;
    

    while(1){

        char* msg = readSocket(socket_server) ;
        printf("%s\n", msg);

        struct MPacket* p = MPacket_Create(msg) ;

        printf("%s %s is valid ? Days : %lld\n", PREFIX, MPacket_formatted(p), MPacket_GetTimeDays(p)) ;

        if(MPacket_IsValidTime(p) == FALSE_VALUE){
            //char* str = p->id_pass+"|R|"+FALSE_VALUE ;
            //sprintf(mystr, "%d", FALSE_VALUE);  
            //printf("mystr : %s\n", mystr) ;
            //mystr[1] = '\0' ;
            //printf("False value\n") ;
            //long l = p->id_pass ;
            //printf("Debug 1\n") ;
            //struct MPacket* p = MPacket_Build(l, REPONSE_VALUE, "1") ;
            //printf("Debug 2\n") ;
            //printf("%s Reponse : %s\n", PREFIX, p->str_defaut) ;

            SendNewPacket(SERVER_ACQUISITION, PORT_ACQUISITION, "false", strlen("false")) ;
            continue ; 
        }

        long pass = MPacket_GetPass(p) ;
        printf("Pass : %ld\n", pass) ;
        int find = FALSE ; 

        int i; 
        for(i=0 ; i<sizeTab ; i++)
            if(tab[i] == pass){
                find = TRUE ;
                break ;
            }
        
        //if(isValid) printf("%s is Valid...\n", PREFIX) ;
        //printf("%s %s is Valid : %d\n", PREFIX, msg, isValid) ;
        //char* reponse = "FALSE" ;
        //if(isValid) reponse = "TRUE" ;
        char* rep = find == FALSE ? "false" : "true" ;
        SendNewPacket(SERVER_ACQUISITION, PORT_ACQUISITION, rep, strlen(rep)) ;
        
    }   

    printf("%s Fin du serveur Validation\n", PREFIX) ;
    return 0 ;
}


